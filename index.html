<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOD Master PRO</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=11">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* Clase para deshabilitar visualmente el botÃ³n durante la carga */
        .btn-loading {
            opacity: 0.7;
            cursor: not-allowed !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-header">
            <div>
                <h1>ğŸ¦¾ WOD Master SaaS</h1>
                <div style="font-size: 0.9em; color: var(--text-muted); margin-top: 5px;">
                    Hola, <b>{{ user.gym_name }}</b> | 
                    
                    {% if user.is_premium %}
                        <span style="color: gold; font-weight: bold;">ğŸ‘‘ PLAN PRO (ILIMITADO)</span>
                    {% else %}
                        <span style="color: #00e676;">ğŸŒ± PLAN GRATIS</span> | 
                        CrÃ©ditos: <b style="color: white; background: #333; padding: 2px 6px; border-radius: 4px;">{{ user.credits }}</b>
                        {% if user.credits == 0 %}
                            <a href="{{ url_for('pricing') }}" style="color: #ff4081; font-weight: bold; margin-left: 5px;">âœ MEJORAR</a>
                        {% endif %}
                    {% endif %}
                    
                    {% if user.stripe_customer_id %}
                        <a href="{{ url_for('billing') }}" class="button secondary" 
                           style="padding: 5px 12px; font-size: 0.8em; margin-left: 10px; border-radius: 20px; background: #333; border-color: #555; text-decoration: none;">
                           ğŸ’³ FacturaciÃ³n
                        </a>
                    {% endif %}

                    {% if user.email == "pau.garcia.ru@gmail.com" %}
                        <a href="{{ url_for('super_admin') }}" class="button" 
                           style="padding: 5px 12px; font-size: 0.8em; margin-left: 10px; border-radius: 20px; background: #d32f2f; color: white; text-decoration: none;">
                           ğŸ•µï¸ Admin
                        </a>
                    {% endif %}
                    
                    <a href="{{ url_for('logout') }}" class="button secondary" 
                       style="padding: 5px 12px; font-size: 0.8em; margin-left: 10px; border-radius: 20px; text-decoration: none;">
                       ğŸšª Salir
                    </a>
                </div>
            </div>
            <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">ğŸŒ</button>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div style="padding: 10px; margin-bottom: 20px; border-radius: 5px; 
                         background: {{ '#00e676' if category == 'success' else '#cf6679' }}; 
                         color: black; text-align: center; font-weight: bold;">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <a href="{{ url_for('add_wod') }}" class="button primary" 
           style="width: 100%; box-sizing: border-box; display:flex; align-items: center; justify-content: center;">
            â• CREAR NUEVO WOD
        </a>
        
        {% if not user.is_premium %}
        <a href="{{ url_for('pricing') }}" class="button" 
           style="width: 100%; box-sizing: border-box; display:flex; align-items: center; justify-content: center; 
                  background: #ffc107; color: black; margin-top: 10px; font-weight: bold; border: 2px solid #ffc107;">
            âš¡ï¸ PASAR A PRO: Desbloquear Contenido Ilimitado y Premium
        </a>
        {% endif %}

        {% if not user.is_premium and user.credits <= 0 %}
        <div style="background: var(--bg-card); border: 1px solid #ff4081; padding: 15px; margin-top: 20px; border-radius: 8px; text-align: center;">
            <h3 style="margin:0; color: #ff4081;">ğŸ”’ Te has quedado sin crÃ©ditos gratuitos</h3>
            <p>PÃ¡sate a PRO para generar contenido ilimitado.</p>
            <a href="{{ url_for('pricing') }}" class="button" style="background: #ff4081; color: white; text-decoration: none;">VER PRECIOS ğŸš€</a>
        </div>
        {% endif %}

        <br>

        {% for wod in wods %}
        <div class="wod-card" id="card-{{wod.id}}">
            
            <div id="story-capture-{{wod.id}}" style="
                position: fixed; top: 0; left: -9999px; /* FUERA DE PANTALLA */
                width: 540px; height: 960px; 
                background: linear-gradient(145deg, #121212, #2d2d2d); 
                display: none; 
                flex-direction: column; 
                justify-content: center; 
                align-items: center; 
                padding: 40px;
                box-sizing: border-box; 
                text-align: center;
                border: 8px solid var(--primary-color);
                z-index: 9999;
                font-family: 'Segoe UI', sans-serif;
                color: white;
            ">
                <div style="width: 100%;">
                     <div style="font-size: 24px; text-transform: uppercase; letter-spacing: 2px; color: #aaaaaa; margin-bottom: 20px;">
                        {{ user.gym_name }}
                    </div>
                    <h1 style="font-size: 48px; color: var(--primary-color); margin: 0 0 30px 0; line-height: 1.1; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                        {{ wod.title }}
                    </h1>
                    <div style="background: #ffffff22; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 18px; margin-bottom: 40px; display: inline-block;">
                        {{ wod.date.strftime('%d/%m') }} â€¢ {{ wod.category|upper }}
                    </div>
                    <div style="
                        background: rgba(0,0,0,0.3); 
                        padding: 30px; 
                        border-radius: 15px; 
                        width: 100%; 
                        font-size: 24px; 
                        white-space: pre-wrap; 
                        text-align: left; 
                        border-left: 5px solid var(--primary-color);
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        box-sizing: border-box;
                    ">
{{ wod.structure }}
                    </div>
                    <div style="margin-top: 40px; font-size: 18px; color: #888;">
                        ğŸ”¥ WORKOUT OF THE DAY ğŸ”¥
                    </div>
                </div>
            </div>

            <div class="wod-header">
                <h2>{{ wod.title }} <span class="tag tag-{{ wod.category|lower }}">{{ wod.category }}</span></h2>
                <span class="wod-date">{{ wod.date.strftime('%d/%m/%Y') }}</span>
            </div>
            
            <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                <span class="wod-tone">ğŸ­ {{ wod.tone }}</span>
                <span class="wod-tone" style="border-color: #9c27b0; color: #9c27b0;">ğŸ¯ {{ wod.target_audience }}</span>
            </div>
            
            <p style="white-space: pre-wrap; border-left: 2px solid var(--border-color); padding-left: 15px; color: var(--text-muted);">{{ wod.structure }}</p>

            <div class="no-capture" style="margin-top: 15px;">
                <a href="{{ url_for('edit_wod', wod_id=wod.id) }}" class="button secondary">âœï¸ Editar</a>
                <form action="{{ url_for('delete_wod', wod_id=wod.id) }}" method="POST" style="display:inline;">
                    <button type="submit" class="button danger" onclick="return confirm('Â¿Seguro?')">ğŸ—‘ï¸</button>
                </form>
                <button class="download-btn" onclick="descargarImagen(this, '{{wod.id}}', '{{wod.title}}')">ğŸ“¸ Story Pro</button>
                
                <a href="{{ url_for('export_pdf', wod_id=wod.id) }}" class="button" style="background: #FF5722; color: white; text-decoration: none; border: none;">
                    ğŸ“„ PDF
                </a>
            </div>

            <form action="{{ url_for('generate_ai_content', wod_id=wod.id) }}" method="POST" onsubmit="return confirmarGeneracion(this, '{{ (wod.ai_instagram_post or "") | length }}', {{ 'true' if user.is_premium else 'false' }})">
                
                {% if user.is_premium or user.credits > 0 %}
                    <button type="submit" class="button ai-button">
                        âœ¨ GENERAR MARKETING IA 
                        {% if not user.is_premium %}(Gasta 1 crÃ©dito){% endif %}
                    </button>
                {% else %}
                    <a href="{{ url_for('pricing') }}" class="button ai-button" style="background: #555; cursor: not-allowed; text-align: center; display: block;">
                        ğŸ”’ NECESITAS PLAN PRO
                    </a>
                {% endif %}
                
                <div class="loading-spinner"><div class="spinner"></div> Creando magia...</div>
            </form>

            {% if wod.ai_instagram_post or wod.ai_warmup or wod.ai_strategy %}
            <div class="ai-section no-capture">
                <h3 style="color: #2979ff; border-bottom: 1px solid var(--border-color);">ğŸ¤– Kit Generado</h3>
                
                {% if wod.ai_strategy %}
                <div class="result-group">
                    <div class="result-header"><label style="color:#00e676;">ğŸ§  Estrategia & Escalados:</label><button class="copy-btn" onclick="copiarTexto('strat-{{wod.id}}')">ğŸ“‹ Copiar</button></div>
                    <textarea readonly id="strat-{{wod.id}}">{{ wod.ai_strategy }}</textarea>
                </div>
                {% endif %}

                {% if wod.ai_warmup %}
                <div class="result-group">
                    <div class="result-header"><label style="color: #ff9800;">ğŸ”¥ Warm-up:</label><button class="copy-btn" onclick="copiarTexto('warm-{{wod.id}}')">ğŸ“‹ Copiar</button></div>
                    <textarea readonly id="warm-{{wod.id}}">{{ wod.ai_warmup }}</textarea>
                </div>
                {% endif %}
                
                {% if wod.ai_instagram_post %}
                <div class="result-group">
                    <div class="result-header"><label>ğŸ“¸ Instagram Post (BÃ¡sico):</label><button class="copy-btn" onclick="copiarTexto('insta-{{wod.id}}')">ğŸ“‹ Copiar</button></div>
                    <textarea readonly id="insta-{{wod.id}}">{{ wod.ai_instagram_post }}</textarea>
                </div>
                {% endif %}

                
                {% if user.is_premium %}
                <hr style="border-color: #9c27b0; margin-top: 30px; margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="result-group">
                            <div class="result-header"><label>ğŸ“§ Newsletter / Email:</label><button class="copy-btn" onclick="copiarTexto('news-{{wod.id}}')">ğŸ“‹ Copiar</button></div>
                            <textarea readonly id="news-{{wod.id}}" style="height: 250px;">{{ wod.ai_newsletter_text }}</textarea>
                        </div>
                        <div class="result-group">
                            <div class="result-header"><label>ğŸ¬ Guion Reel / TikTok:</label><button class="copy-btn" onclick="copiarTexto('reel-{{wod.id}}')">ğŸ“‹ Copiar</button></div>
                            <textarea readonly id="reel-{{wod.id}}" style="height: 250px;">{{ wod.ai_reel_script }}</textarea>
                        </div>
                    </div>
                {% else %}
                    <div style="background: var(--bg-body); border: 2px dashed #9c27b0; padding: 20px; text-align: center; margin: 20px 0; border-radius: 8px;">
                        <h4 style="color: #9c27b0; margin-top: 0;">ğŸ”’ Contenido Exclusivo Plan PRO</h4>
                        <p>El Guion de Reel y la Newsletter son exclusivos del plan PRO.</p>
                        <a href="{{ url_for('pricing') }}" class="button download-btn" style="text-decoration: none;">Â¡MEJORAR A PRO!</a>
                    </div>
                {% endif %}
                
            </div>
            {% endif %}
        </div>
        {% else %}
            <div style="text-align: center; padding: 40px; border: 2px dashed var(--border-color); color: var(--text-muted);">
                <h3>ğŸ“­ Crea tu primer WOD para empezar</h3>
            </div>
        {% endfor %}

        <hr style="margin: 50px 0; border-color: #333;">
        <div style="text-align: center; padding-bottom: 50px;">
            <p style="color: #666; font-size: 0.8em;">Zona de Peligro</p>
            <form action="{{ url_for('delete_account') }}" method="POST" onsubmit="return confirm('âš ï¸ Â¿ESTÃS SEGURO? Se borrarÃ¡n todos tus datos y no se pueden recuperar.');">
                <button type="submit" class="button danger" style="background: transparent; border: 1px solid #cf6679; color: #cf6679;">
                    ğŸ’€ Eliminar mi Cuenta
                </button>
            </form>
        </div>
    </div>

    <script>
        const btnTheme = document.getElementById('theme-toggle');
        const body = document.body;
        if (localStorage.getItem('theme') === 'light') { body.classList.add('light-mode'); btnTheme.innerText = 'ğŸŒ™'; } 
        else { btnTheme.innerText = 'ğŸŒ'; }
        
        function toggleTheme() {
            body.classList.toggle('light-mode');
            localStorage.setItem('theme', body.classList.contains('light-mode') ? 'light' : 'dark');
            btnTheme.innerText = body.classList.contains('light-mode') ? 'ğŸŒ™' : 'ğŸŒ';
        }

        function confirmarGeneracion(form, len, isPremium) {
            if (parseInt(len) > 5) {
                if (isPremium) {
                    if (!confirm("Â¿Regenerar el contenido?")) return false;
                } else {
                    if (!confirm("Â¿Regenerar? Se gastarÃ¡ 1 crÃ©dito extra.")) return false;
                }
            }
            form.querySelector('.ai-button').style.display='none';
            form.querySelector('.loading-spinner').style.display='block';
            return true;
        }

        function copiarTexto(id) {
            var t = document.getElementById(id); t.select(); navigator.clipboard.writeText(t.value);
            alert("Copiado!");
        }

        function cerrarStoryManualmente(id) {
            document.getElementById('story-capture-'+id).style.display = 'none';
        }

        // --- FUNCIÃ“N OPTIMIZADA: INVISIBLE Y RÃPIDA ---
        function descargarImagen(btn, id, t) {
            const captureDiv = document.getElementById('story-capture-'+id);
            const originalBtnText = btn.innerHTML;

            // 1. Feedback inmediato en el botÃ³n
            btn.innerHTML = 'âš™ï¸ Generando...';
            btn.classList.add('btn-loading');
            btn.disabled = true;

            // 2. Mostrar el div pero FUERA DE PANTALLA (left: -9999px en CSS)
            captureDiv.style.display = 'flex';

            // 3. Espera mÃ­nima (100ms) solo para que el navegador pinte el layout
            setTimeout(() => {
                html2canvas(captureDiv, {
                    scale: 2, 
                    backgroundColor: null,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    // 4. Descargar
                    let l = document.createElement('a');
                    l.download = 'WOD-Story-' + t.replace(/\s/g, '_') + '.png';
                    l.href = canvas.toDataURL('image/png');
                    l.click();

                    // 5. Limpieza rÃ¡pida
                    captureDiv.style.display = 'none';
                    btn.innerHTML = originalBtnText;
                    btn.classList.remove('btn-loading');
                    btn.disabled = false;

                }).catch(err => {
                     console.error("Error generando imagen:", err);
                     alert("Hubo un problema generando la imagen.");
                     captureDiv.style.display = 'none';
                     btn.innerHTML = originalBtnText;
                     btn.classList.remove('btn-loading');
                     btn.disabled = false;
                });
            }, 100); // <-- 100ms es suficiente para pintar y mucho mÃ¡s rÃ¡pido que 800ms
        }
    </script>
</body>
</html>